<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TapTrack - AI-Powered Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
        .tap-btn:active, .start-timer-btn:active { transform: scale(0.96); }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        input[type="radio"]:checked + div, input[type="checkbox"]:checked + div { --tw-ring-color: #3b82f6; box-shadow: 0 0 0 2px var(--tw-ring-color); }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tracker-card-body { cursor: pointer; }
        .timer-fill { transition: height 0.5s linear; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="flex flex-col md:flex-row h-screen">
        <!-- Left Sidebar -->
        <aside class="w-full md:w-64 bg-white p-4 shadow-lg flex-col border-r border-slate-200">
            <h1 class="text-2xl font-bold text-slate-900 mb-8">TapTrack</h1>
            <nav class="flex flex-col space-y-3">
                 <button id="my-auras-btn" class="flex items-center justify-between p-3 rounded-lg text-white bg-blue-600 font-semibold shadow-md">
                    <div class="flex items-center space-x-3"><span>My Auras</span></div>
                    <div id="aura-score-container" class="flex items-center space-x-1 text-sm"><span id="aura-icon"></span><span id="aura-score">0</span></div>
                </button>
                 <button id="journey-btn" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 hover:text-slate-800 transition-all duration-200">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                     <span>My Journey</span>
                 </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="w-full p-4 md:p-6 lg:p-8 flex-grow overflow-y-auto custom-scrollbar">
            <div id="tracker-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div class="w-full mt-8 bg-white rounded-xl shadow-md p-4 border border-slate-200">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg">Recent Activity</h3>
                    <div class="flex items-center gap-4">
                        <button id="reflect-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-2">✨ Reflect on My Week</button>
                        <button id="reset-all-button" class="text-sm text-slate-500 hover:text-red-600 font-semibold">Reset All</button>
                    </div>
                </div>
                <ul id="log-list" class="space-y-2 text-left custom-scrollbar overflow-y-auto max-h-48">
                    <li id="log-placeholder" class="text-slate-400 p-2">No activity yet.</li>
                </ul>
            </div>
        </main>
    </div>

    <!-- Modals are defined here -->
    <div id="add-tracker-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden pointer-events-none opacity-0">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-2xl shadow-xl transform scale-95 overflow-y-auto max-h-[95vh]">
             <h2 id="modal-title" class="text-2xl font-bold mb-6">Create a New Aura</h2>
             <form id="add-tracker-form" class="space-y-5">
                <input type="hidden" id="edit-tracker-id">
                 <h3 class="text-xl font-bold">Details</h3>
                <input type="text" id="tracker-name" placeholder="Aura Name (e.g., Mindfulness)" class="w-full p-3 border-2 border-slate-300 rounded-lg" required>
                <textarea id="tracker-desc" placeholder="Description (optional)..." rows="2" class="w-full p-3 border-2 border-slate-300 rounded-lg"></textarea>
                <textarea id="initial-tracker-note" placeholder="Add your first intention or note..." rows="3" class="w-full p-3 border-2 border-slate-300 rounded-lg"></textarea>
                <div>
                    <label class="font-semibold text-slate-600 block mb-2">Aura Type</label>
                    <div class="flex gap-4"><label class="flex-1"><input type="radio" name="auraType" value="positive" class="sr-only" checked><div class="p-3 border-2 border-slate-300 rounded-lg text-center cursor-pointer">Positive Habit</div></label><label class="flex-1"><input type="radio" name="auraType" value="negative" class="sr-only"><div class="p-3 border-2 border-slate-300 rounded-lg text-center cursor-pointer">Avoid Habit</div></label></div>
                </div>
                <div><label class="font-semibold text-slate-600 block mb-2">Goal Type</label><div id="goal-type-options" class="grid grid-cols-2 gap-2"><label><input type="radio" name="goalType" value="tap" class="sr-only" checked><div class="p-3 border-2 border-slate-300 rounded-lg text-center cursor-pointer">Tap Counter</div></label><label><input type="radio" name="goalType" value="timer" class="sr-only"><div class="p-3 border-2 border-slate-300 rounded-lg text-center cursor-pointer">Timer</div></label></div></div>
                <div id="tap-options-container">
                    <label class="font-semibold text-slate-600 block mb-2">Tap Frequency</label>
                    <div class="grid grid-cols-3 gap-2"><label><input type="radio" name="repeatType" value="daily" class="sr-only" checked><div class="p-3 border-2 border-slate-300 rounded-lg text-center cursor-pointer">Every Day</div></label><label><input type="radio" name="repeatType" value="weekly" class="sr-only"><div class="p-3 border-2 border-slate-300 rounded-lg text-center cursor-pointer">Specific Days</div></label><label><input type="radio" name="repeatType" value="interval" class="sr-only"><div class="p-3 border-2 border-slate-300 rounded-lg text-center cursor-pointer">Interval</div></label></div>
                    <div id="weekly-repeat-container" class="mt-4 hidden"><label class="font-semibold text-slate-600 block mb-2">Repeat on</label><div class="flex justify-between gap-1">
                        <label><input type="checkbox" name="weekdays" value="0" class="sr-only"> <div class="w-10 h-10 flex items-center justify-center rounded-full border-2 cursor-pointer">S</div></label>
                        <label><input type="checkbox" name="weekdays" value="1" class="sr-only"> <div class="w-10 h-10 flex items-center justify-center rounded-full border-2 cursor-pointer">M</div></label>
                        <label><input type="checkbox" name="weekdays" value="2" class="sr-only"> <div class="w-10 h-10 flex items-center justify-center rounded-full border-2 cursor-pointer">T</div></label>
                        <label><input type="checkbox" name="weekdays" value="3" class="sr-only"> <div class="w-10 h-10 flex items-center justify-center rounded-full border-2 cursor-pointer">W</div></label>
                        <label><input type="checkbox" name="weekdays" value="4" class="sr-only"> <div class="w-10 h-10 flex items-center justify-center rounded-full border-2 cursor-pointer">T</div></label>
                        <label><input type="checkbox" name="weekdays" value="5" class="sr-only"> <div class="w-10 h-10 flex items-center justify-center rounded-full border-2 cursor-pointer">F</div></label>
                        <label><input type="checkbox" name="weekdays" value="6" class="sr-only"> <div class="w-10 h-10 flex items-center justify-center rounded-full border-2 cursor-pointer">S</div></label>
                    </div></div>
                    <div id="interval-repeat-container" class="mt-4 hidden"><label class="font-semibold text-slate-600 block mb-2">Repeat Every (Days)</label><input type="number" name="repeatInterval" value="1" class="w-full p-3 border-2 border-slate-300 rounded-lg" min="1"></div>
                </div>
                <div id="timer-options-container" class="hidden"><label for="timer-duration" class="font-semibold text-slate-600 block mb-2">Timer Duration (minutes)</label><input type="number" id="timer-duration" name="timerDuration" placeholder="e.g., 30" class="w-full p-3 border-2 border-slate-300 rounded-lg" min="1"></div>
                <div><label class="font-semibold text-slate-600 block mb-2">Icon</label><div id="icon-picker" class="flex flex-wrap gap-2 p-2 bg-slate-100 rounded-lg"></div></div>
                <div><label class="font-semibold text-slate-600 block mb-2">End Date (optional)</label><input type="date" id="end-date" name="endDate" class="w-full p-3 border-2 border-slate-300 rounded-lg"></div>
                <div class="flex justify-end gap-3 pt-4"><button type="button" class="cancel-modal-btn px-5 py-2 bg-slate-200 rounded-lg font-semibold">Cancel</button><button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-lg font-semibold">Save</button></div>
            </form>
        </div>
    </div>
    <div id="aura-detail-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden pointer-events-none opacity-0">
         <div class="modal-content bg-white w-full max-w-lg p-6 rounded-2xl shadow-xl transform scale-95 flex flex-col h-[90vh]"><div id="detail-header" class="flex-shrink-0"></div><div id="detail-notes-list" class="flex-grow my-4 overflow-y-auto custom-scrollbar space-y-3 pr-2"></div><form id="detail-add-note-form" class="flex-shrink-0"><input type="hidden" id="detail-tracker-id"><textarea id="detail-new-note-text" placeholder="Add a new thought..." rows="2" class="w-full p-3 border-2 border-slate-300 rounded-lg" required></textarea><div class="flex justify-between gap-3 mt-3"><div class="flex gap-2"><button type="button" id="edit-aura-btn" class="px-5 py-2 bg-slate-600 text-white rounded-lg font-semibold">Edit</button><button type="button" id="delete-aura-btn" class="px-5 py-2 bg-red-600 text-white rounded-lg font-semibold">Delete</button></div><div class="flex gap-2"><button type="button" class="cancel-modal-btn px-5 py-2 bg-slate-200 rounded-lg font-semibold">Close</button><button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-lg font-semibold">Add Note</button></div></div></form></div>
    </div>
    <div id="journey-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden pointer-events-none opacity-0">
        <div class="modal-content bg-white w-full max-w-2xl p-6 rounded-2xl shadow-xl transform scale-95 flex flex-col h-[90vh]"><h2 class="text-2xl font-bold mb-4">My Journey</h2><p class="text-slate-600 mb-4">This is your private space to reflect on your overall journey.</p><textarea id="journey-text-area" class="w-full h-full p-3 border-2 border-slate-200 rounded-lg flex-grow custom-scrollbar" placeholder="Start writing your story..."></textarea><div class="flex justify-end mt-6"><button type="button" class="cancel-modal-btn px-5 py-2 bg-slate-200 rounded-lg font-semibold">Close</button></div></div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let trackers = []; let journeyStory = ""; const AURA_LIMIT = 6;
            const availableIcons = ['�', '💊', '🧘', '🚭', '💪', '📖', '🙏', '🍁', '❤️', '⭐', '😊', '🌱', '🏃', '📱', '🕒'];
            let activeTimers = {};

            const ui = {
                trackerGrid: document.getElementById('tracker-grid'), logList: document.getElementById('log-list'), resetAllButton: document.getElementById('reset-all-button'),
                reflectBtn: document.getElementById('reflect-btn'), auraScoreDisplay: document.getElementById('aura-score'), auraIconDisplay: document.getElementById('aura-icon'),
                journeyBtn: document.getElementById('journey-btn'), journeyModal: document.getElementById('journey-modal'), journeyTextArea: document.getElementById('journey-text-area'),
                addTrackerModal: document.getElementById('add-tracker-modal'), addTrackerForm: document.getElementById('add-tracker-form'), modalTitle: document.getElementById('modal-title'),
                auraDetailModal: document.getElementById('aura-detail-modal'), editTrackerIdInput: document.getElementById('edit-tracker-id'),
                iconPicker: document.getElementById('icon-picker'), goalTypeOptions: document.getElementById('goal-type-options'),
                tapOptionsContainer: document.getElementById('tap-options-container'), timerOptionsContainer: document.getElementById('timer-options-container'),
                weeklyRepeatContainer: document.getElementById('weekly-repeat-container'), intervalRepeatContainer: document.getElementById('interval-repeat-container'),
                detailHeader: document.getElementById('detail-header'), detailNotesList: document.getElementById('detail-notes-list'),
                detailAddNoteForm: document.getElementById('detail-add-note-form'), detailTrackerIdInput: document.getElementById('detail-tracker-id'),
                editAuraBtn: document.getElementById('edit-aura-btn'), deleteAuraBtn: document.getElementById('delete-aura-btn'),
                initialNoteContainer: document.getElementById('initial-tracker-note')
            };

            const isSameDay = (d1, d2) => d1.setHours(0,0,0,0) === d2.setHours(0,0,0,0);
            
            function getPreviousScheduledDay(tracker, fromDate) {
                if (tracker.goal.type !== 'tap' || !tracker.goal.repeat) return null;
                const schedule = tracker.goal.repeat.days;
                if (!schedule) return null; // Not a weekly schedule
                let checkDate = new Date(fromDate);
                checkDate.setDate(checkDate.getDate() - 1);
                for (let i = 0; i < 7; i++) { // Check back max 7 days
                    if (schedule.includes(checkDate.getDay())) {
                        return checkDate;
                    }
                    checkDate.setDate(checkDate.getDate() - 1);
                }
                return null;
            }

            function isScheduledForToday(tracker) {
                const today = new Date();
                if (tracker.endDate && today > new Date(tracker.endDate)) return false;
                if (!tracker.goal) return false; // Should not happen, but a good safeguard.
                if (tracker.goal.type === 'timer') return true; // Timers are always available unless an end date passed.
                
                // Only tap goals have repeat schedules
                if (tracker.goal.type === 'tap' && tracker.goal.repeat) {
                    const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon,...
                    const repeat = tracker.goal.repeat;
                    if (repeat.type === 'daily') return true;
                    if (repeat.type === 'weekly') return repeat.days.includes(dayOfWeek);
                    if (repeat.type === 'interval') {
                        const startDate = new Date(tracker.createdAt);
                        startDate.setHours(0,0,0,0);
                        const todayForDiff = new Date();
                        todayForDiff.setHours(0,0,0,0);
                        const diffTime = Math.abs(todayForDiff - startDate);
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        return diffDays % repeat.interval === 0;
                    }
                }
                return false;
            }

            function renderGrid() {
                clearIntervals();
                ui.trackerGrid.innerHTML = ''; 
                trackers.forEach(tracker => {
                    const card = document.createElement('div');
                    card.className = "tracker-card bg-white p-5 rounded-2xl shadow-lg flex flex-col justify-between border-t-4 border-blue-500";
                    card.innerHTML = getCardHTML(tracker);
                    ui.trackerGrid.appendChild(card);
                    if (tracker.goal.type === 'timer' && tracker.timerEndTime) startTimerInterval(tracker);
                });
                 if (trackers.length < AURA_LIMIT) {
                    ui.trackerGrid.insertAdjacentHTML('beforeend', `<div id="add-new-card" class="bg-white p-5 rounded-2xl shadow-lg flex items-center justify-center border-4 border-dashed border-slate-300 hover:border-blue-500 hover:bg-slate-50 cursor-pointer transition-all"><div class="text-center text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="mt-2 font-bold">Add New Aura</p></div></div>`);
                } else {
                    ui.trackerGrid.insertAdjacentHTML('beforeend', `<div class="bg-slate-100 p-5 rounded-2xl flex items-center justify-center border-4 border-dashed border-slate-300"><div class="text-center text-slate-500"><p class="font-bold">Aura limit reached</p></div></div>`);
                }
                updateAuraDisplay();
            }

            function getCardHTML(tracker) {
                const today = new Date();
                const tapsToday = tracker.lastTaps.filter(t => isSameDay(new Date(t), new Date())).length;
                let isTapDisabled = !isScheduledForToday(tracker);
                let buttonContent = tracker.goal.type === 'timer' ? 'START' : 'TAP';
                let progressText = `${tracker.icon}`;

                if(tracker.goal.type === 'timer') {
                    progressText += ` ${tracker.goal.duration}m`;
                    if (tracker.timerEndTime && new Date() < new Date(tracker.timerEndTime)) {
                        isTapDisabled = true; buttonContent = '...';
                    }
                } else {
                     progressText += ` ${tapsToday}`;
                     if (tapsToday > 0) isTapDisabled = true; // For now, disable after one tap for scheduled items
                }
                if (!isScheduledForToday(tracker)) buttonContent = "Not scheduled";

                return `<div class="tracker-card-body" data-id="${tracker.id}">
                            <div class="flex justify-between items-start mb-2"><h3 class="text-lg font-bold text-slate-800">${tracker.name}</h3><div class="flex items-center gap-2"><span class="text-sm font-bold text-orange-500 flex items-center gap-1 ${tracker.streak > 0 ? '' : 'hidden'}">🔥 ${tracker.streak}</span><div class="text-2xl font-extrabold text-slate-700 count-display">${progressText}</div></div></div>
                            <p class="text-sm text-slate-600 truncate">${tracker.notes.length > 0 ? tracker.notes[0].text : 'No notes yet...'}</p>
                        </div>
                        <button class="tap-btn relative overflow-hidden w-full mt-4 py-3 px-4 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 flex items-center justify-center gap-2 transition-opacity ${isTapDisabled ? 'opacity-50 cursor-not-allowed bg-slate-400 hover:bg-slate-400' : ''}" data-id="${tracker.id}" ${isTapDisabled ? 'disabled' : ''}>
                           <div class="timer-fill absolute bottom-0 left-0 w-full bg-blue-800/50" style="height: 0%;"></div><span class="relative z-10">${buttonContent}</span>
                        </button>`;
            }

            function startTimerInterval(tracker) {
                const button = document.querySelector(`.tap-btn[data-id="${tracker.id}"]`);
                const fill = button.querySelector('.timer-fill');
                if (!button || !fill) return;
                const durationMs = tracker.goal.duration * 60 * 1000;
                const startTime = new Date(tracker.timerEndTime).getTime() - durationMs;
                activeTimers[tracker.id] = setInterval(() => {
                    const now = new Date();
                    const end = new Date(tracker.timerEndTime);
                    if (now >= end) {
                        clearInterval(activeTimers[tracker.id]); delete activeTimers[tracker.id]; tracker.timerEndTime = null;
                        logTap(tracker.id); addLogEntry(`Completed timer for: <strong>${tracker.name}</strong>`);
                    } else {
                        const elapsed = now - startTime;
                        const progress = (elapsed / durationMs) * 100;
                        fill.style.height = `${progress}%`;
                        const remaining = Math.ceil((end - now) / 1000);
                        const minutes = Math.floor(remaining / 60);
                        const seconds = remaining % 60;
                        button.querySelector('.z-10').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            }
            
            function clearIntervals() { Object.values(activeTimers).forEach(clearInterval); activeTimers = {}; }
            
            function calculateDailyScore() {
                const today = new Date();
                return trackers.reduce((totalScore, tracker) => {
                    const tapsToday = tracker.lastTaps.filter(t => isSameDay(new Date(t), new Date())).length;
                    const notesToday = tracker.notes.filter(n => n.timestamp && isSameDay(new Date(n.timestamp), new Date())).length;
                    const tapValue = tracker.auraType === 'negative' ? tapsToday * -5 : tapsToday * 1; // Negative habits have more weight
                    return totalScore + tapValue + (tracker.streak * 2) + (notesToday * 5);
                }, 0);
            }

            function updateAuraDisplay() {
                const score = calculateDailyScore();
                ui.auraScoreDisplay.textContent = score;
                if (score >= 50) ui.auraIconDisplay.innerHTML = `<span class="text-orange-400 text-lg">🔥</span>`;
                else if (score >= 20) ui.auraIconDisplay.innerHTML = `<span class="text-yellow-400 text-lg">⭐</span>`;
                else if (score > 0) ui.auraIconDisplay.innerHTML = `<span class="text-blue-400 text-lg">✨</span>`;
                else ui.auraIconDisplay.innerHTML = '';
            }

            function openModal(modal) { modal.classList.remove('hidden', 'pointer-events-none', 'opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }
            function closeModal(modal) { modal.classList.add('opacity-0', 'pointer-events-none'); modal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => modal.classList.add('hidden'), 300); }
            
            function renderAuraDetail(trackerId) {
                const tracker = trackers.find(t => t.id === trackerId);
                if (!tracker) return;
                ui.detailHeader.innerHTML = `<h2 class="text-2xl font-bold">${tracker.icon} ${tracker.name}</h2><p class="text-slate-600 mt-1">${tracker.description || 'No description.'}</p>`;
                ui.detailNotesList.innerHTML = tracker.notes.map(note => `<div class="bg-slate-100 p-3 rounded-lg text-sm">${note.text || note}</div>`).join('') || '<p class="text-slate-400">No notes yet.</p>';
                ui.detailTrackerIdInput.value = trackerId;
                openModal(ui.auraDetailModal);
            }

            function addLogEntry(logText) {
                document.getElementById('log-placeholder')?.remove();
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                ui.logList.insertAdjacentHTML('afterbegin', `<li class="log-entry flex justify-between items-center bg-slate-50 p-2 rounded-md"><span class="text-sm font-medium text-slate-700">${logText}</span><span class="text-xs text-slate-500">${timeString}</span></li>`);
            }
            
            function logTap(trackerId){
                 const tracker = trackers.find(t => t.id === trackerId);
                 const today = new Date();
                 const lastTapDate = tracker.lastTaps.length > 0 ? new Date(tracker.lastTaps[tracker.lastTaps.length - 1]) : null;
                 const prevScheduledDay = getPreviousScheduledDay(tracker, today);
                 if (lastTapDate && prevScheduledDay && isSameDay(lastTapDate, prevScheduledDay)) {
                     tracker.streak++;
                 } else if (!lastTapDate || !isSameDay(lastTapDate, today)) {
                     tracker.streak = 1;
                 }
                 tracker.lastTaps.push(today.toISOString());
                 renderGrid();
                 addLogEntry(`Tapped: <span class="font-bold">${tracker.name}</span>`);
            }
            
            ui.trackerGrid.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('#add-new-card')) {
                    ui.addTrackerForm.reset(); ui.editTrackerIdInput.value = ''; ui.modalTitle.textContent = "Create New Aura";
                    ui.initialNoteContainer.style.display = 'block';
                    ui.weeklyRepeatContainer.classList.add('hidden'); ui.intervalRepeatContainer.classList.add('hidden');
                    populateIconPicker(); openModal(ui.addTrackerModal); return;
                }
                const cardBody = target.closest('.tracker-card-body');
                if (cardBody) { renderAuraDetail(parseInt(cardBody.dataset.id)); return; }
                const tapButton = target.closest('.tap-btn');
                if (tapButton) {
                    const trackerId = parseInt(tapButton.dataset.id);
                    const tracker = trackers.find(t => t.id === trackerId);
                    if (tracker.goal.type === 'timer') {
                        tracker.timerEndTime = new Date(Date.now() + tracker.goal.duration * 60 * 1000).toISOString();
                        renderGrid();
                    } else { logTap(trackerId); }
                }
            });

            ui.addTrackerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editId = parseInt(ui.editTrackerIdInput.value);
                const name = document.getElementById('tracker-name').value;
                const description = document.getElementById('tracker-desc').value;
                const initialNote = document.getElementById('initial-tracker-note').value;
                const auraType = ui.addTrackerForm.querySelector('input[name="auraType"]:checked').value;
                const icon = ui.addTrackerForm.querySelector('input[name="icon"]:checked').value;
                const goalType = ui.addTrackerForm.querySelector('input[name="goalType"]:checked').value;
                const endDate = document.getElementById('end-date').value || null;

                let goal;
                if (goalType === 'timer') {
                    const duration = document.getElementById('timer-duration').value;
                    goal = { type: 'timer', duration: parseInt(duration) || 1 };
                } else {
                    const repeatType = ui.addTrackerForm.querySelector('input[name="repeatType"]:checked').value;
                    goal = { type: 'tap', repeat: { type: repeatType } };
                    if (repeatType === 'weekly') {
                        goal.repeat.days = Array.from(ui.addTrackerForm.querySelectorAll('input[name="weekdays"]:checked')).map(el => parseInt(el.value));
                    } else if (repeatType === 'interval') {
                        const interval = document.querySelector('input[name="repeatInterval"]').value;
                        goal.repeat.interval = parseInt(interval) || 1;
                    }
                }

                const newAuraData = { name, description, icon, auraType, goal, endDate, createdAt: new Date().toISOString() };

                if (editId) {
                    const tracker = trackers.find(t => t.id === editId);
                    Object.assign(tracker, newAuraData);
                    addLogEntry(`Updated Aura: <strong>${tracker.name}</strong>`);
                } else {
                    trackers.push({
                        id: Date.now(), ...newAuraData,
                        notes: [initialNote.trim()].filter(Boolean).map(text => ({ text, timestamp: new Date().toISOString() })),
                        streak: 0, lastTaps: []
                    });
                    addLogEntry(`Created Aura: <strong>${newAuraData.name}</strong>`);
                }
                renderGrid();
                closeModal(ui.addTrackerModal);
            });
            
            ui.detailAddNoteForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const trackerId = parseInt(ui.detailTrackerIdInput.value);
                const tracker = trackers.find(t => t.id === trackerId);
                const newNoteText = document.getElementById('detail-new-note-text').value;
                if (tracker && newNoteText.trim() !== '') {
                    tracker.notes.unshift({text: newNoteText.trim(), timestamp: new Date().toISOString()});
                    addLogEntry(`Note added to: <strong>${tracker.name}</strong>`);
                    renderAuraDetail(trackerId); renderGrid();
                    document.getElementById('detail-new-note-text').value = '';
                }
            });

            ui.editAuraBtn.addEventListener('click', () => {
                const trackerId = parseInt(ui.detailTrackerIdInput.value);
                const tracker = trackers.find(t => t.id === trackerId);
                if(!tracker) return;
                closeModal(ui.auraDetailModal); ui.addTrackerForm.reset(); ui.modalTitle.textContent = "Edit Aura";
                ui.editTrackerIdInput.value = tracker.id; document.getElementById('tracker-name').value = tracker.name;
                document.getElementById('tracker-desc').value = tracker.description; ui.initialNoteContainer.style.display = 'none';
                document.querySelector(`input[name=auraType][value=${tracker.auraType}]`).checked = true;
                document.querySelector(`input[name=goalType][value=${tracker.goal.type}]`).checked = true;
                document.getElementById('end-date').value = tracker.endDate ? new Date(tracker.endDate).toISOString().split('T')[0] : '';
                
                const isTimer = tracker.goal.type === 'timer';
                ui.timerOptionsContainer.classList.toggle('hidden', !isTimer);
                ui.tapOptionsContainer.classList.toggle('hidden', isTimer);

                if (tracker.goal.type === 'tap') {
                     document.querySelector(`input[name=repeatType][value=${tracker.goal.repeat.type}]`).checked = true;
                     ui.weeklyRepeatContainer.classList.toggle('hidden', tracker.goal.repeat.type !== 'weekly');
                     ui.intervalRepeatContainer.classList.toggle('hidden', tracker.goal.repeat.type !== 'interval');
                     if(tracker.goal.repeat.type === 'weekly') {
                         tracker.goal.repeat.days.forEach(dayIndex => document.querySelector(`input[name=weekdays][value="${dayIndex}"]`).checked = true);
                     } else if (tracker.goal.repeat.type === 'interval') {
                          document.querySelector('input[name=repeatInterval]').value = tracker.goal.repeat.interval;
                     }
                } else {
                    document.getElementById('timer-duration').value = tracker.goal.duration;
                }
                populateIconPicker();
                document.querySelector(`input[name=icon][value="${tracker.icon}"]`).checked = true;
                openModal(ui.addTrackerModal);
            });

            ui.deleteAuraBtn.addEventListener('click', () => {
                if(!confirm("Are you sure you want to delete this Aura permanently?")) return;
                const trackerId = parseInt(ui.detailTrackerIdInput.value);
                trackers = trackers.filter(t => t.id !== trackerId);
                addLogEntry("Aura deleted."); closeModal(ui.auraDetailModal); renderGrid();
            });
            
            ui.addTrackerForm.addEventListener('change', (e) => {
                 if (e.target.name === 'goalType') {
                    const isTimer = e.target.value === 'timer';
                    ui.timerOptionsContainer.classList.toggle('hidden', !isTimer);
                    ui.tapOptionsContainer.classList.toggle('hidden', isTimer);
                } else if (e.target.name === 'repeatType') {
                    const type = e.target.value;
                    ui.weeklyRepeatContainer.classList.toggle('hidden', type !== 'weekly');
                    ui.intervalRepeatContainer.classList.toggle('hidden', type !== 'interval');
                 }
            });
            
            ui.journeyBtn.addEventListener('click', () => { ui.journeyTextArea.value = journeyStory; openModal(ui.journeyModal); });
            ui.journeyTextArea.addEventListener('input', () => { journeyStory = ui.journeyTextArea.value; });
            document.querySelectorAll('.cancel-modal-btn').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal'))));
            
            function populateIconPicker() {
                ui.iconPicker.innerHTML = '';
                availableIcons.forEach((icon, i) => ui.iconPicker.innerHTML += `<label><input type="radio" name="icon" value="${icon}" class="sr-only" ${i === 0 ? 'checked' : ''}><span class="text-2xl p-2 rounded-md inline-block cursor-pointer bg-slate-200 hover:bg-slate-300 transition-transform">${icon}</span></label>`);
            }
            renderGrid();
        });
    </script>
</body>
</html>
�